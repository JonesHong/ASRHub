# ASR Hub 優化配置檔案
# 根據 PyStoreX 重構後的架構調整
# 生成時間: 2025-08-19

# ===== 系統核心設定 =====
system:
  name: "ASR_Hub"
  version: "0.2.0"  # 重構後版本
  mode: ${APP_ENV:development}  # development, production, testing
  debug: ${DEBUG:true}

# ===== 日誌設定 =====
logging:
  path: "./logs"
  rotation: "100 MB"
  retention: "30 days"
  level: "INFO"  # TRACE, DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "detailed"  # detailed, simple, json

# ===== API 設定 =====
api:
  # HTTP SSE (Server-Sent Events)
  http_sse:
    enabled: true
    host: ${API_HOST:0.0.0.0}
    port: ${API_PORT:8000}
    cors_enabled: true
    max_connections: 100
    request_timeout: 300  # 秒
    
  # WebSocket
  websocket:
    enabled: true
    host: ${WS_HOST:0.0.0.0}
    port: ${WS_PORT:8765}
    max_message_size: 10485760  # 10 MB
    ping_interval: 30
    
  # Socket.IO
  socketio:
    enabled: true
    host: ${SOCKETIO_HOST:0.0.0.0}
    port: ${SOCKETIO_PORT:8766}
    cors_allowed_origins: "*"
    
  # gRPC (保留但預設關閉)
  grpc:
    enabled: false
    host: ${GRPC_HOST:0.0.0.0}
    port: ${GRPC_PORT:50051}
    max_receive_message_length: 10485760
    
  # Redis (保留但預設關閉)
  redis:
    enabled: false
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    db: ${REDIS_DB:0}
    password: ${REDIS_PASSWORD:}
    channel_prefix: "asr_hub:"

# ===== Pipeline 設定 =====
pipeline:
  # 音訊基本參數
  default_sample_rate: 16000
  channels: 1  # 單聲道
  encoding: "int16"
  buffer_size: 4096
  max_pipeline_length: 10
  
  # Operators 配置
  operators:
    # 喚醒詞偵測
    wakeword:
      enabled: true
      type: "openWakeWord"
      model_path: "models/hi_kmu_0721.onnx"
      threshold: 0.5
      debounce_time: 2.0
      continuous_detection: true
      inference_threads: 1
      use_quantized_model: false
      
    # VAD (語音活動偵測)
    vad:
      enabled: true
      type: "silero"  # webrtc, silero
      silero:
        enabled: true
        threshold: 0.5
        min_silence_duration: 0.5
        min_speech_duration: 0.25
        model_path: "models/silero_vad.onnx"
        model_name: "silero_vad_v4"
        use_gpu: false
        adaptive_threshold: false  # 避免過度敏感
        threshold_window_size: 50
        smoothing_window: 10  # 增大以減少抖動
      webrtc:
        enabled: false
        aggressiveness: 2  # 0-3
        frame_duration: 30  # ms
        padding_duration: 300  # ms
      
    # 降噪
    denoise:
      enabled: false
      type: "rnnoise"
      strength: 0.7
      
    # 取樣率調整
    sample_rate_adjustment:
      enabled: true
      target_rate: 16000
      quality: "high"
      
    # 格式轉換
    format_conversion:
      enabled: true
      target_format: "pcm"
      channels: 1
      bits_per_sample: 16
      
    # 錄音功能
    recording:
      enabled: true
      format: "wav"
      sample_rate: 48000
      channels: 2
      max_duration: 60  # seconds
      max_file_size: 100  # MB
      storage:
        type: "file"  # memory, file, s3
        path: "./recordings"
      # VAD 控制設定
      vad_control:
        enabled: true
        silence_countdown: 1.8
        min_recording_duration: 0.5
        pre_speech_buffer: 0.3
        post_speech_buffer: 0.2
      # 分段錄音
      segmentation:
        enabled: false
        segment_duration: 30.0
        overlap_duration: 0.5
      # 元數據
      metadata:
        enabled: true
        include_vad_info: true
        include_timestamps: true
        save_path: "./recordings/metadata"

# ===== ASR Provider 設定 =====
providers:
  default: "whisper"
  
  # 通用池化配置模板
  pool_defaults:
    min_size: 1
    max_size: 3
    idle_timeout: 300.0
    acquire_timeout: 30.0
    health_check_interval: 60.0
    auto_scale:
      enabled: true
      scale_up_threshold: 0.8
      scale_down_threshold: 0.3
      scale_interval: 60.0
  
  # Local Whisper
  whisper:
    enabled: true
    model_size: ${WHISPER_MODEL:base}
    language: "zh"
    device: ${WHISPER_DEVICE:cpu}
    compute_type: "float32"
    beam_size: 5
    best_of: 5
    temperature: 0.0
    use_faster_whisper: true
    initial_prompt: null
    vad_filter: false
    model_path: "./models/whisper"
    pool:
      enabled: false
      min_size: 1
      max_size: 3
    
  # FunASR
  funasr:
    enabled: false
    model: "paraformer"
    language: "zh"
    device: "cpu"
    model_path: "./models/funasr"
    
  # Vosk
  vosk:
    enabled: false
    model_path: "./models/vosk/vosk-model-cn-0.22"
    sample_rate: 16000
    
  # Google Cloud STT
  google_stt:
    enabled: false
    credentials_path: ${GOOGLE_APPLICATION_CREDENTIALS:}
    language_code: "zh-TW"
    encoding: "LINEAR16"
    sample_rate: 16000
    enable_automatic_punctuation: true
    
  # OpenAI API
  openai:
    enabled: false
    api_key: ${OPENAI_API_KEY:}
    model: "whisper-1"
    language: "zh"
    temperature: 0.0
    base_url: ${OPENAI_BASE_URL:https://api.openai.com/v1}

# ===== 喚醒詞設定 =====
wake_word_detection:
  enabled: true
  system_listener:
    enabled: true
    always_on: true
    buffer_size: 4096
    min_resource_mode: true
  wake_timeout: 3.0
  cooldown: 2.0
  models:
    - type: openWakeWord
      enabled: true
      model_path: "models/hi_kmu_0721.onnx"
      threshold: 0.5
      language: "zh-TW"
      hf_repo_id: "JTBTechnology/kmu_wakeword"
      hf_filename: "hi_kmu_0721.onnx"
      hf_token: ${HF_TOKEN:}
      inference_framework: "onnxruntime"
      use_gpu: false
      batch_size: 1
      sample_rate: 16000
      window_size: 1280
      score_queue_size: 60
      cache_embeddings: true
      preload_model: true
  wake_events:
    publish_to_api: true
    include_audio_context: false
    context_duration: 2.0
  multi_source:
    ui_wake: false
    visual_wake: false
    gesture_wake: false

# ===== 串流設定 =====
stream:
  # 音訊參數
  sample_rate: 16000
  channels: 1
  
  # 超時設定
  silence_timeout: 3.0
  initial_silence_timeout: 10.0
  max_segment_duration: 30.0
  enable_vad: true
  
  # 手動終止
  manual_termination: true
  termination_phrase: "結束辨識"
  
  # Busy 模式
  busy_mode:
    enabled: true
    continue_listening: true
    buffer_audio: true
    max_buffer_duration: 30.0
    
  # 緩衝設定
  buffer:
    size: 8192
    max_chunks: 1000
    overflow_strategy: "drop_oldest"

# ===== FSM (狀態機) 設定 =====
fsm:
  # 通用設定
  default_strategy: "NON_STREAMING"  # BATCH, NON_STREAMING, STREAMING
  keep_awake_after_reply: true
  
  # 統一的超時配置（毫秒）
  timeout_configs:
    # BATCH 模式
    batch:
      processing: 60000
      
    # NON_STREAMING 模式
    non_streaming:
      activated: 5000
      recording: 10000
      transcribing: 5000
      llm_claim: 5000
      tts_claim: 5000
      session_idle: 600000
      
    # STREAMING 模式
    streaming:
      activated: 5000
      streaming: 30000
      llm_claim: 5000
      tts_claim: 5000
      session_idle: 600000
  
  # 狀態回復設定
  recovery:
    max_retry_attempts: 3
    retry_delay_ms: 1000
    auto_recover_from_error: true
    
  # 事件優先級設定
  event_priorities:
    reset: 100
    error: 90
    recover: 90
    interrupt_reply: 60
    llm_reply_started: 50
    tts_playback_started: 50
    tts_playback_finished: 40
    timeout: 30
    default: 0

# ===== 以下區塊已確認未使用，建議移除 =====
# 如果未來需要這些功能，可以重新加入

# # 效能設定（未使用）
# performance:
#   thread_pool:
#     min_workers: 2
#     max_workers: 10
#   memory:
#     max_usage_mb: 2048
#     gc_threshold: 0.8
#   batch:
#     enabled: false
#     size: 10
#     timeout: 1.0

# # 安全設定（未使用）
# security:
#   auth:
#     enabled: false
#     type: "api_key"
#     api_keys: []
#   rate_limit:
#     enabled: true
#     requests_per_minute: 60
#     requests_per_hour: 1000
#   ssl:
#     enabled: false
#     cert_file: ${SSL_CERT_FILE:}
#     key_file: ${SSL_KEY_FILE:}

# # 監控設定（未使用）
# monitoring:
#   metrics:
#     enabled: false
#     export_interval: 60
#   health_check:
#     enabled: true
#     endpoint: "/health"
#     check_interval: 30
#   tracing:
#     enabled: false
#     service_name: "asr-hub"

# # 資料庫設定（未使用）
# database:
#   enabled: false
#   type: "sqlite"
#   sqlite:
#     path: "./data/asr_hub.db"
#   host: ${DB_HOST:localhost}
#   port: ${DB_PORT:5432}
#   name: ${DB_NAME:asr_hub}
#   user: ${DB_USER:postgres}
#   password: ${DB_PASSWORD:}
#   pool:
#     size: 10
#     max_overflow: 20
#     timeout: 30