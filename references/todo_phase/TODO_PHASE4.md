# ASR_Hub 第四階段工作清單

## 📋 階段目標
在前三階段完成的基礎上，實作喚醒詞偵測功能，整合 openWakeWord 模型，建立雙層監聽架構，完善有限狀態機（FSM）以支援喚醒詞相關狀態。本階段專注於 openWakeWord 基礎實作，暫不包含 ASR 關鍵字喚醒詞、智慧 pipeline 和整合測試優化。

## ✅ 工作項目清單

### 1. OpenWakeWord Operator 實作（src/pipeline/operators/wakeword/）

#### 1.1 OpenWakeWord Operator 基礎架構
- [ ] 1.1.1 建立 OpenWakeWordOperator 類別（繼承 OperatorBase）
  - 整合 openWakeWord 模型載入機制
  - 實作 ONNX 模型推論引擎
  - 支援 HuggingFace 私有模型下載（使用 HF_TOKEN）
  - 實作模型快取機制
- [ ] 1.1.2 實作即時音訊處理
  - 處理 16kHz 音訊輸入（自動重採樣）
  - 實作滑動視窗機制（1280 樣本/幀）
  - 維護 60 幀的評分佇列（deque）
  - 支援多個喚醒詞模型同時運行
- [ ] 1.1.3 實作喚醒詞偵測邏輯
  - 設定可配置的閾值（預設 0.5）
  - 實作評分平滑機制
  - 支援連續偵測和單次偵測模式
  - 實作去抖動（debounce）機制

#### 1.2 模型管理和配置
- [ ] 1.2.1 實作模型管理器
  - 支援本地模型載入
  - 支援 HuggingFace Hub 下載
  - 實作模型版本管理
  - 模型效能基準測試
- [ ] 1.2.2 配置系統整合
  - 更新 YAML 配置結構以支援喚醒詞設定
  - 支援多模型配置（每個模型獨立閾值）
  - 實作動態模型切換
  - 支援敏感度調整

#### 1.3 效能優化
- [ ] 1.3.1 實作模型推論優化
  - 使用 ONNX Runtime 優化
  - 支援批次推論（如果適用）
  - 實作模型量化支援
  - GPU 加速支援（可選）
- [ ] 1.3.2 記憶體和 CPU 優化
  - 實作環形緩衝區減少記憶體分配
  - 使用 NumPy 向量化操作
  - 實作執行緒池進行並行處理
  - 監控資源使用情況

### 2. 雙層監聽架構實作

#### 2.1 系統層監聽（底層）
- [ ] 2.1.1 建立 SystemListener 類別
  - Always-on 監聽實作
  - 獨立於用戶層 Pipeline
  - 最小資源消耗設計
  - 支援多種喚醒源（語音、UI、視覺）
- [ ] 2.1.2 實作事件分發機制
  - 喚醒事件定義和傳播
  - 事件優先級管理
  - 跨模組事件同步
  - 事件日誌和追蹤

#### 2.2 用戶層監聽（表層）
- [ ] 2.2.1 更新現有 Pipeline 架構
  - 支援動態啟用/停用
  - 與系統層協調機制
  - 狀態同步管理
  - 資源共享優化
- [ ] 2.2.2 實作串流控制增彷
  - 基於 FSM 狀態的串流管理
  - 支援暫停和恢復
  - 緩衝區狀態保持
  - 優雅的終止機制

### 3. FSM 狀態機增強（src/core/fsm.py）

#### 3.1 新增 IDLE 狀態支援
- [ ] 3.1.1 更新 FSM 狀態定義
  - 新增 IDLE 狀態（待機狀態）
  - 更新狀態轉換規則
  - 實作狀態轉換驗證
  - 狀態持久化支援
- [ ] 3.1.2 實作喚醒相關轉換
  - IDLE → LISTENING（偵測到喚醒詞）
  - LISTENING → IDLE（wake_timeout）
  - BUSY → LISTENING（處理完成）
  - 異常狀態恢復機制

#### 3.2 事件處理機制
- [ ] 3.2.1 定義事件類型
  - WakeWordDetectedEvent（語音喚醒）
  - UIWakeEvent（UI 喚醒）
  - VisualWakeEvent（視覺喚醒）
  - SystemProcessingEvent（系統處理事件）
- [ ] 3.2.2 實作事件處理器
  - 事件註冊和訂閱機制
  - 事件處理優先級
  - 事件聚合和去重
  - 非同步事件處理

### 4. Session Manager 增強（src/core/session_manager.py）

#### 4.1 喚醒詞相關 Session 管理
- [ ] 4.1.1 更新 Session 模型
  - 新增 wake_timeout 欄位
  - 新增 wake_source 追蹤
  - 喚醒歷史記錄
  - Session 優先級管理
- [ ] 4.1.2 實作 Session 生命週期增強
  - 基於喚醒狀態的 Session 管理
  - 自動清理休眠 Session
  - Session 狀態快照
  - 跨協定 Session 同步

#### 4.2 多源喚醒協調
- [ ] 4.2.1 實作喚醒源管理器
  - 註冊多個喚醒源
  - 喚醒源優先級配置
  - 衝突解決機制
  - 喚醒源健康監控
- [ ] 4.2.2 實作基本喚醒策略
  - 單一喚醒詞優先級
  - 喚醒事件去重機制
  - 狀態轉換驗證

### 5. Pipeline 基礎整合

#### 5.1 Pipeline Manager 更新
- [ ] 5.1.1 支援雙層 Pipeline 管理
  - 系統層 Pipeline（輕量）
  - 用戶層 Pipeline（完整）
  - Pipeline 切換機制
  - 資源隔離管理
- [ ] 5.1.2 實作 Pipeline 協調器
  - 跨層 Pipeline 同步
  - 狀態一致性保證
  - 錯誤傳播控制
  - 效能監控和調優

### 6. API 層支援更新

#### 6.1 控制指令擴展
- [ ] 6.1.1 新增喚醒詞相關指令
  - wake：手動喚醒
  - sleep：手動休眠
  - set_wake_timeout：設定喚醒超時
  - get_wake_status：查詢喚醒狀態
- [ ] 6.1.2 更新現有 API 實作
  - HTTP SSE 支援新指令
  - WebSocket 支援新指令（待實作）
  - Socket.io 支援新指令（待實作）
  - 統一的指令處理邏輯

#### 6.2 事件推送增強
- [ ] 6.2.1 實作喚醒事件推送
  - 喚醒詞偵測事件
  - 狀態變更事件
  - 超時警告事件
  - 系統狀態同步
- [ ] 6.2.2 實作事件訂閱機制
  - 選擇性事件訂閱
  - 事件過濾器
  - 批次事件推送
  - 事件重放支援

### 7. 配置系統更新

#### 7.1 YAML 配置擴展
- [ ] 7.1.1 新增喚醒詞配置區塊
  ```yaml
  wake_word_detection:
    enabled: true
    system_listener:
      enabled: true
      always_on: true
    wake_timeout: 30.0  # 秒
    models:
      - type: openWakeWord
        enabled: true
        model_path: "models/hi_kmu_0721.onnx"
        threshold: 0.5
        language: "zh-TW"
      # ASR 關鍵字比對暫不實作
  ```
- [ ] 7.1.2 使用 yaml2py 重新生成配置類別
  - 更新配置 schema
  - 驗證配置完整性
  - 支援配置熱更新
  - 配置版本管理

### 8. 工具和輔助功能

#### 8.1 喚醒詞測試工具
- [ ] 8.1.1 建立喚醒詞測試腳本
  - 即時麥克風測試
  - 音檔批次測試
  - 效能基準測試
  - 準確率統計
- [ ] 8.1.2 建立視覺化監控工具
  - 即時評分顯示（類似 kmu_wakeword 範例）
  - 多模型對比顯示
  - 歷史記錄查看
  - 導出測試報告

#### 8.2 除錯和監控
- [ ] 8.2.1 實作喚醒詞專用日誌
  - 詳細的偵測日誌
  - 效能指標記錄
  - 錯誤和異常追蹤
  - 日誌分析工具
- [ ] 8.2.2 實作監控指標
  - 喚醒成功率
  - 誤喚醒率
  - 回應時間統計
  - 資源使用監控


## 🔍 驗收標準
1. ✅ openWakeWord 可以成功載入並偵測指定喚醒詞
2. ✅ 雙層監聽架構正常運作，系統層 always-on
3. ✅ FSM 正確處理 IDLE、LISTENING、BUSY 三種狀態
4. ✅ 所有 API 協定支援喚醒詞相關功能（HTTP SSE 已完成）
5. ⏳ 喚醒延遲 < 500ms，CPU 使用率 < 10%（待測試驗證）
6. ⏳ 完整的測試工具和監控指標（部分完成）
7. ✅ 配置系統完整支援所有喚醒詞功能

## 📝 注意事項
1. 優先實作 openWakeWord operator，這是核心功能
2. 注意系統層和用戶層的資源隔離，避免相互影響
3. 確保 FSM 狀態轉換的原子性和一致性
4. 使用 pretty-loguru 記錄所有喚醒相關事件
5. 保持低延遲和低資源消耗的設計原則
6. 支援動態配置更新，無需重啟服務
7. 考慮隱私保護，喚醒詞偵測應在本地完成
8. 為未來擴展預留接口（如視覺喚醒、手勢喚醒等）
9. 本階段專注於 openWakeWord 基礎實作，ASR 關鍵字比對留待後續階段

## 🚀 實作優先順序建議
1. **第一優先級**：OpenWakeWord Operator 基礎實作
2. **第二優先級**：FSM 狀態機增強（新增 IDLE 狀態）
3. **第三優先級**：雙層監聽架構
4. **第四優先級**：API 層更新和事件推送
5. **第五優先級**：測試工具和監控

---
建立時間：2025-07-29
最後更新：2025-07-29
負責人：ASR Hub Team