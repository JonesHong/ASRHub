<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 連接測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-4">WebSocket 連接測試</h1>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">WebSocket URL:</label>
                <input type="text" id="wsUrl" value="ws://localhost:8765/ws" 
                       class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div class="flex gap-4">
                <button onclick="testConnection()" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    測試連接
                </button>
                <button onclick="sendTestAction()" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    發送測試 Action
                </button>
                <button onclick="disconnect()" 
                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    斷開連接
                </button>
            </div>
            
            <div id="status" class="p-4 bg-gray-100 rounded">
                <h3 class="font-semibold mb-2">狀態:</h3>
                <div id="statusText">未連接</div>
            </div>
            
            <div id="logs" class="p-4 bg-gray-100 rounded h-64 overflow-y-auto">
                <h3 class="font-semibold mb-2">日誌:</h3>
                <div id="logContent"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-600' : 
                         type === 'success' ? 'text-green-600' : 
                         'text-gray-700';
            
            logContent.innerHTML += `
                <div class="${color}">
                    [${timestamp}] ${message}
                </div>
            `;
            logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
        }
        
        function updateStatus(status, color = 'text-gray-700') {
            const statusText = document.getElementById('statusText');
            statusText.textContent = status;
            statusText.className = color;
        }
        
        function testConnection() {
            const url = document.getElementById('wsUrl').value;
            
            if (ws) {
                ws.close();
            }
            
            addLog(`嘗試連接到: ${url}`);
            updateStatus('連接中...', 'text-yellow-600');
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    addLog('WebSocket 連接成功！', 'success');
                    updateStatus('已連接', 'text-green-600');
                    
                    // 發送初始化訊息
                    const initMessage = {
                        type: 'init',
                        timestamp: Date.now()
                    };
                    ws.send(JSON.stringify(initMessage));
                    addLog(`發送初始化訊息: ${JSON.stringify(initMessage)}`);
                };
                
                ws.onmessage = (event) => {
                    addLog(`收到訊息: ${event.data}`);
                    
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'error') {
                            addLog(`伺服器錯誤: ${data.message || '未知錯誤'}`, 'error');
                        }
                    } catch (e) {
                        // 非 JSON 訊息
                    }
                };
                
                ws.onerror = (error) => {
                    addLog(`WebSocket 錯誤: ${error.message || '連接失敗'}`, 'error');
                    updateStatus('連接錯誤', 'text-red-600');
                };
                
                ws.onclose = (event) => {
                    addLog(`連接關閉 (代碼: ${event.code}, 原因: ${event.reason || '未知'})`);
                    updateStatus('已斷開', 'text-gray-600');
                    ws = null;
                };
                
            } catch (error) {
                addLog(`建立連接失敗: ${error.message}`, 'error');
                updateStatus('連接失敗', 'text-red-600');
            }
        }
        
        function sendTestAction() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('WebSocket 未連接', 'error');
                return;
            }
            
            const testAction = {
                type: 'action',
                action: {
                    type: 'SESSION_CREATE',
                    payload: {
                        session_id: `test-${Date.now()}`,
                        protocol: 'websocket',
                        timestamp: Date.now()
                    }
                }
            };
            
            ws.send(JSON.stringify(testAction));
            addLog(`發送測試 Action: ${JSON.stringify(testAction)}`);
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                addLog('手動斷開連接');
            } else {
                addLog('沒有活動的連接', 'error');
            }
        }
        
        // 頁面載入時自動測試
        window.onload = () => {
            addLog('測試頁面已載入，請點擊「測試連接」開始');
        };
    </script>
</body>
</html>